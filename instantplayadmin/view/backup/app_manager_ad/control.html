<style>
    .sub-title {
        font-weight: 600; 
        font-size: 14px;
        margin: 0;
    }
    .sub-body {
        margin-left: 20px;
        margin-right: 40px;
        font-weight: 400; 
        font-size: 14px;
    }
    .title_span{
        display: inline-block;
        width: 100px;
        margin-top: 10px;
        margin-bottom: 10px;    
    }
    .name_select {
        display: inline-block;
        width: 140px;
        margin-top: 10px;
        margin-bottom: 10px;
        margin-right: 40px;
    }
    .hint_span, .settNotice{
        font-size: 12px;
        font-weight: 100; 
        display: block;
        margin-top: 10px;
        margin-bottom: 10px;    
    }
    .settUl dt{
        font-weight: normal;
    }
    .settUl dt i,.settUl dt em{
        font-style: normal;
    }
    .settLi>span{
        display:block;
        margin-bottom: 10px;
        font-weight: 600;
    }
    .settUl .game_name,.settUl .settNotice{
        display: block;
        margin:10px 0;
    }
    .basicMessage {
        margin-left: 103px;
        margin-top: 10px;
    }
    .settUl {
        margin-left: 6px;
    }
</style>
<!-- BEGIN CONTAINER -->
<div class="page-container">
    {include layout/left.html}

    <div class="page-content-wrapper">
        <div class="page-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light">
                        <div class="portlet-title">
                        </div>
                        <div class="portlet-body">
                            <div class="table-container">
                                <div class="table-actions-wrapper">
                                    <span>
                                    </span>
                                    <button type="button" id="addCtrl" class="btn btn-sm default blue">添加控制</button>
                                </div>
                                <table class="table table-striped table-bordered table-hover" id="datatable_products">
                                    <thead>
                                    <tr role="row" class="heading">
                                        <th width="5%">
                                            控制状态
                                        </th>
                                        <th width="5%">
                                            广告类型
                                        </th>
                                        {if !isset($foreign) || !$foreign}
                                        <th width="5%">
                                            广告位ID
                                        </th>
                                        {/if}
                                        <th width="5%">
                                            操作控制
                                        </th>
                                        <th width="5%">
                                            控制时间类型
                                        </th>
                                        <th width="5%">
                                            时间范围
                                        </th>
                                        <th width="5%">
                                            适用用户
                                        </th>
                                        <th width="5%">
                                            添加人
                                        </th>
                                        <th width="5%">
                                            创建时间
                                        </th>
                                        <th width="5%">
                                            修改时间
                                        </th>
                                        <th width="5%">
                                            操作
                                        </th>
                                    </tr>
                                    <tr role="row" class="filter">
                                        <td>
                                            <select name="ctrl_status" class="form-control form-filter input-sm">
                                                <option value=0>全部</option>
                                                <option value=1>有效</option>
                                                <option value=2>失效</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="ad_type" class="form-control form-filter input-sm">
                                                <option value="">全部</option>
                                            {foreach ($adTypeDesc as  $k=>$v)  }
                                                <option value="{$k}">{$v}</option>
                                            {/foreach}
                                            </select>
                                        </td>
                                        {if !isset($foreign) || !$foreign}
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="ad_id" >
                                        </td>
                                        {/if}
                                        <td>
                                            <select name="ctrl_type" class="form-control form-filter input-sm">
                                                <option value="">全部</option>
                                            {foreach ($ctrlTypeDesc as  $k=>$v)  }
                                                <option value="{$k}">{$v}</option>
                                            {/foreach}
                                            </select>
                                        </td>

                                        <td>
                                            <select name="time_ctrl_type" class="form-control form-filter input-sm">
                                                <option value="">全部</option>
                                            {foreach ($timeCtrlTypeDesc as  $k=>$v)  }
                                                <option value="{$k}">{$v}</option>
                                            {/foreach}
                                            </select>
                                        </td>

                                        <td></td>

                                        <td>
                                            <select name="user_type" class="form-control form-filter input-sm">
                                                <option value="">请选择</option>
                                            {foreach ($userTypeDesc as  $k=>$v)  }
                                                <option value="{$k}">{$v}</option>
                                            {/foreach}
                                            </select>
                                        </td>

                                        <td></td>

                                        <td>
                                            <div class="input-group date form_datetime margin-bottom-5">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px" readonly name="from_a" id="from_a" placeholder="From">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button" style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button" style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>


                                            <div class="input-group date form_datetime margin-bottom-5">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px"  readonly name="to_a" id="to_a" placeholder="to">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button"  style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button"  style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="input-group date form_datetime margin-bottom-5" data-date-format="yyyy-mm-dd">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px" readonly name="from_u" id="from_u" placeholder="From">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button" style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button" style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>


                                            <div class="input-group date form_datetime margin-bottom-5">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px"  readonly name="to_u" id="to_u" placeholder="to">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button"  style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button"  style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="margin-bottom-5">
                                                <button class="btn btn-sm yellow filter-submit margin-bottom"><i class="fa fa-search"></i> 搜索</button>
                                            </div>
                                            <button class="btn btn-sm green filter-cancel"><i class="fa fa-times"></i> 重置</button>
                                        </td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- End: life time stats -->
                </div>
            </div>
            <!-- END PAGE CONTENT-->
        </div>
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width: 800px">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">添加控制</h4>
            </div>
            
            <div class="modal-body" style="width: 800px;margin-left: 20px">
                <p class="sub-title">选择作用对象</p>
                <hr style="width: 700px;">

                <!-- 基本设置 -->
                <div class="sub-body">
                    <span class="title_span">广告类型</span>
                    <select id="ad_type" class="name_select">
                        <option value=0>请选择</option>
                        {foreach ($adTypeDesc as $k=>$v)}
                        <option value="{$k}">{$v}</option>
                        {/foreach}
                    </select>
                    <span class="hint_span">注：如果只对全局某种类型的广告进行控制，只需选择广告类型即可。</span>
                </div>
                {if !isset($foreign) || !$foreign}
                <div class="sub-body">
                    <span class="title_span">广告位ID</span>
                    <select id="ad_id" class="name_select">
                        <option value=0>全部</option>
                        {foreach ($advertise_type as $k=>$v)}
                        <option value="{$k}">{$v}</option>
                        {/foreach}
                    </select>
                    <span class="hint_span">注：如果需要对某种广告类型中某调广告进行控制，需对广告位ID进行选择。</span>
                </div>
                {/if}

                <hr style="width: 700px;">

                <div class="sub-body">
                    <span class="title_span">操作控制</span>
                    <select id="ctrl_type" class="name_select">
                        <option value=0>请选择</option>
                        {foreach ($ctrlTypeDesc as $k=>$v)}
                        <option value="{$k}">{$v}</option>
                        {/foreach}
                    </select>
                    <div class="basicMessage" id="ctrl_state">
                        <div class="settLi">
                            <div>
                                <label for="radio1_2"> <input type="radio" class="input_check" id="radio1_2" value="2" name="adSwitch">关闭</label>
                            </div>
                        </div>
                    </div>
                    <div class="basicMessage" id="ctrl_frequency">
                        <div class="settLi">
                            <div>
                                <label for="radio2_1"><input type="radio" class="input_check" id="radio2_1" value="1" name="adSet" checked="">广告之间的间隔</label>
                                <label for="radio2_2"> <input type="radio" class="input_check" id="radio2_2" value="2" name="adSet">广告时间的间隔</label>
                            </div>
                        </div>
                        <div class="settLi">
                            <dl class="settUl">
                                <dt class="active">
                                    <div class="game_name">广告之间的间隔时间（单位“秒”）</div>
                                    <div>
                                        <input id="interval" type="text" value="" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')"  />
                                    </div>
                                    <i class="settNotice">注：设置每位用户在一次播放完广告后间隔多久进行下一次的广告播放。</i>
                                </dt>
                                <dt>
                                    <div class="game_name">时间段内广告最多可出现的次数</div>
                                    <div>
                                        <input id="times" type="text" maxlength="3" value="" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" oninput="if(value>100)value=100;if(value!='' && value==0)value=1" /><em>（请输入1-100之间的数字）</em>
                                    </div>
                                    <div class="game_name">时间段（小时）</div>
                                    <div>
                                        <input id="period" type="text" maxlength="2" value="" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" oninput="if(value>48)value=48;if(value!='' && value==0)value=1" /><em>（请输入1-48之间的数字）</em>
                                    </div>
                                    <i class="settNotice">注：设置每位用户在设定时间段内可能看到自动播放广告的频率。</i>
                                </dt>
                            </dl>
                        </div>
                    </div>
                </div>

                <hr style="width: 700px;">
    
                <div class="sub-body">
                    <span class="title_span">控制时间</span>
                    <select id="time_ctrl_type" class="name_select">
                        <option value=0>请选择</option>
                        {foreach ($timeCtrlTypeDesc as $k=>$v)}
                        <option value="{$k}">{$v}</option>
                        {/foreach}
                    </select>
                    <div id="time_ctrl_set">
                        <div class="basicMessage">
                            <span class="title_span">开始时间</span>
                            <div class="input-group date form_datetime margin-bottom-5" data-date-format="yyyy-mm-dd" style="display: inline-table;width: 160px;vertical-align: middle;margin: 0;">
                                <input type="text" id="time_ctrl_from" class="form-control form-filter input-sm" style="height: 34px;" readonly  placeholder="From">
                                <span class="input-group-btn">
                                    <button class="btn default date-set" type="button" style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                </span>
                            </div>
                        </div>

                        <div class="basicMessage">
                            <span class="title_span">结束时间</span>
                            <div class="input-group date form_datetime margin-bottom-5" data-date-format="yyyy-mm-dd" style="display: inline-table;width: 160px;vertical-align: middle;margin: 0;">
                                <input type="text" id="time_ctrl_to" class="form-control form-filter input-sm" style="height: 34px;" readonly  placeholder="To">
                                <span class="input-group-btn">
                                    <button class="btn default date-set" type="button" style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                </div>
                    
                <hr style="width: 700px;">

                <div class="sub-body">
                    <span class="title_span">适用用户</span>
                    <select id="user_type" class="name_select">
                        <option value=-1>请选择</option>
                        {foreach ($userTypeDesc as $k=>$v)}
                        <option value="{$k}">{$v}</option>
                        {/foreach}
                    </select>
                </div>
                <hr style="width: 700px;">
            </div>

            <div class="modal-footer-diy" align="center">
                <button type="button" class="undo" style="margin-right: 20px" data-dismiss="modal">取消</button>
                <button type="button" class="save">确认</button>
            </div>

            <br><br>
            
        </div>
    </div>
</div>

<script>

    var EcommerceProducts = function () {

        var initPickers = function () {
            //init date pickers
            $('.date-picker').datepicker({
                rtl: Metronic.isRTL(),
                autoclose: true
            });
        }

        var handleProducts = function () {
            var grid = new Datatable();

            grid.init({
                src: $("#datatable_products"),
                onSuccess: function (grid) {
                    // execute some code after table records loaded
                },
                onError: function (grid) {
                    // execute some code on network or other general error
                },
                loadingMessage: 'Loading...',
                dataTable: { // here you can define a typical datatable settings from http://datatables.net/usage/options

                    // Uncomment below line("dom" parameter) to fix the dropdown overflow issue in the datatable cells. The default datatable layout
                    // setup uses scrollable div(table-scrollable) with overflow:auto to enable vertical scroll(see: assets/global/scripts/datatable.js).
                    // So when dropdowns used the scrollable div should be removed.
                    //"dom": "<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'<'table-group-actions pull-right'>>r>t<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'>>",

                    "lengthMenu": [
                        [10, 20, 50, 100, 150, 999999],
                        [10, 20, 50, 100, 150, '所有(会很慢)'] // change per page values here
                    ],
                    "pageLength": 20, // default record count per page
                    "ajax": {
                        "url": "/app_manager_ad/no/control/getList/" // ajax source
                    },
                    "aoColumnDefs": [{  // define columns sorting options(by default all columns are sortable extept the first checkbox column)
                        'bSortable': false,
                        'aTargets': [],
                    }],
                    "order": [
                    ] // set first column as a default sort by asc
                }
            });


        }

        return {

            //main function to initiate the module
            init: function () {
                handleProducts();
                initPickers();

            }

        };

    }();
    
    var isNew = 1;
    var id = 0;

    jQuery(document).ready(function () {
        EcommerceProducts.init();

        $("#addCtrl").click(function(){
            id = 0;
            isNew = 1;
            clearModal();
            $("#myModal").modal();
        })

        getAdIds();
        $("#ad_type").change(function(){
            var html="<option value=0>全部</option>";
            $("#ad_id").html(html);
            getAdIds();
        });
        
        switchCtrlType();
        $('#ctrl_type').change(function() {
            switchCtrlType();
        });
        
        switchAd2();
        $('input[name="adSet"]').change(function() {
            switchAd2();
        });
        
        switchTimeCtrlType();
        $('#time_ctrl_type').change(function() {
            switchTimeCtrlType();
        });

        $(".save").click(function() {
            if (!isNew && !id) {
                alert("参数错误");
                return false;
            }

            var adType = $("#ad_type").val();
            var adId = $("#ad_id").val();
            var ctrlType = $("#ctrl_type").val();
            var timeCtrlType = $("#time_ctrl_type").val();
            var userType = $("#user_type").val();

            if (!hasValue(adType) || !hasValue(ctrlType) || !hasValue(timeCtrlType) || userType==-1)
            {
                alert("请补全信息");
                return false;
            }

            var postData = {
                id:id,
                isNew:isNew,
                adType:adType,
                adId:adId,
                ctrlType:ctrlType,
                timeCtrlType:timeCtrlType,
                userType:userType
            }

            if (ctrlType == 1) {
                var frequencyType = 0;
                var interval = 0;
                var times = 0;
                var period = 0;

                frequencyType = $('input[name="adSet"]:checked').val();
                if (!hasValue(frequencyType)) {
                    alert('请设定广告频次');
                    return false;
                } else if (frequencyType == 1) {
                    interval = $("#interval").val();
                    if (!hasValue(interval)) {
                        alert('请设定广告间隔');
                        return false;
                    }
                } else if (frequencyType == 2) {
                    times = $("#times").val();
                    if (!hasValue(times)) {
                        alert('请设定广告展示次数');
                        return false;
                    }
                    period = $("#period").val();
                    if (!hasValue(period)) {
                        alert('请设定时间段');
                        return false;
                    }
                }
                postData.frequencyType = frequencyType;
                postData.interval = interval;
                postData.times = times;
                postData.period = period;
            } else if (ctrlType == 2) {
                var state = $('input[name="adSwitch"]:checked').val();
                if (!hasValue(state)) {
                    alert('请选择开关');
                    return false;
                }
                postData.state = state;
            }

            if (timeCtrlType == 2) {
                var from = $("#time_ctrl_from").val();
                var to = $("#time_ctrl_to").val();
                if (!hasValue(from) || !hasValue(to)) {
                    alert('请选择起止时间');
                    return false;
                }
                postData.from = from;
                postData.to = to;
            }

            $.ajax({
                url: "/app_manager_ad/no/control/save/",
                type: "GET",
                data: postData,
                dataType: "json",
                success: function (data) {
                    alert(data.message);
                    if (data.code == 200) {
                        location.reload();
                    }
                    return;
                }
            });
        });

    });

    function switchAd2(){
        var indexSetting=$('input[name="adSet"]:checked').val();
        $(".settUl").find("dt").eq(indexSetting-1).show().siblings("dt").hide();
    };

    function switchCtrlType() {
        $("#ctrl_state").hide();
        $("#ctrl_frequency").hide();
        var ctrlType = $("#ctrl_type").val();
        if (ctrlType == 1) {
            $("#ctrl_frequency").show();
        } else if (ctrlType == 2) {
            $("#ctrl_state").show();
        } 
    }

    function switchTimeCtrlType() {
        $("#time_ctrl_set").hide();
        var timeCtrlType = $("#time_ctrl_type").val();
        if (timeCtrlType == 2) {
            $("#time_ctrl_set").show();
        } 
    }

    function clearModal() {
        $("#ad_type").val(0);
        var html="<option value=0>全部</option>";
        $("#game_name").html(html);
        $("#ad_id").html(html);
        $("#ctrl_type").val(0);
        $("#ctrl_state").hide();
        $("#ctrl_frequency").hide();
        $("#interval").val('');
        $("#times").val('');
        $("#period").val('');
        $("#time_ctrl_type").val(0);
        $("#time_ctrl_set").hide();
        $("#time_ctrl_from").val('');
        $("#time_ctrl_to").val('');
        $("#user_type").val(-1);
    }

    function getConfig(elem) {
        clearModal();
        id = $(elem).attr('attr-id');
        isNew = 0;

        $.ajax({
            url: "/app_manager_ad/no/control/getConfig/",
            type: "GET",
            data: {id:id},
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    var record = data.data.record;
                    var adIds = data.data.adIds;

                    $("#ad_type").val(record.ad_type);

                    if (adIds.length != 0) {
                        var html="<option value=0>全部</option>";
                        for (var i=0; i<adIds.length; i++) {
                            html += "<option value="+adIds[i].id+">"+adIds[i].id+"</option>";
                        }
                        $("#ad_id").html(html);
                        $("#ad_id").val(record.ad_id);
                    }

                    $("#ctrl_type").val(record.ctrl_type);

                    if (record.ctrl_type == 1) {
                        $("#ctrl_frequency").show();
                        $('input[name="adSet"]').each(function() {
                            if (record.frequency_type == $(this).val()) {
                                $(this).attr("checked",true);
                                $(this).parents("span").addClass("checked");
                                switchAd2();
                            } else {
                                $(this).parents("span").removeClass("checked");
                            }
                            if (record.frequency_type == 1) {
                                $("#interval").val(record.interval);
                            } else if (record.frequency_type == 2) {
                                $("#times").val(record.times);
                                $("#period").val(record.period);
                            }
                        });
                     
                    } else if (record.ctrl_type == 2) {
                        $("#ctrl_state").show();
                        $('input[name="adSwitch"]').each(function() {
                            if (record.state == $(this).val()) {
                                $(this).attr("checked",true);
                                $(this).parents("span").addClass("checked");
                                switchAd2();
                            } else {
                                $(this).parents("span").removeClass("checked");
                            }
                        });
                    }
                    

                    $("#time_ctrl_type").val(record.time_ctrl_type);
                    if (record.time_ctrl_type == 2) {
                        $("#time_ctrl_set").show();
                        $("#time_ctrl_from").val(record.from);
                        $("#time_ctrl_to").val(record.to);
                    }

                    $("#user_type").val(record.user_type);

                    $("#myModal").modal();
                } else {
                    alert(data.message);
                }
                return;
            }
        });
    }

    function getAdIds() {
        var adType = $("#ad_type").val();

        if (!hasValue(adType)) {
            return false;
        }

        $.ajax({
            url: "/app_manager_ad/no/control/getAdIds/",
            type: "GET",
            data: {
                adType: adType
            },
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    var adIds = data.data;
                    var html="<option value=0>全部</option>";
                    for (var i=0; i<adIds.length; i++) {
                        html += "<option value="+adIds[i].id+">"+adIds[i].id+"</option>";
                    }
                    $("#ad_id").html(html);
                } else {
                    alert(data.message);return;
                }
            }
        });
    }

    function hasValue(val) {
        if (!val || val==0 || val=='' || val==undefined) {
            return false;
        }
        return true;
    }

</script>


<script>
    if (!jQuery().datetimepicker) {
        alert(333);
    }

    $(".form_datetime").datetimepicker({
        isRTL: Metronic.isRTL(),
        minView: "month",
        format: "yyyy-mm-dd",
        autoclose: true,
        todayBtn: true,
        startDate: "2019-01-01",
        pickerPosition: (Metronic.isRTL() ? "bottom-right" : "bottom-left"),
        minuteStep: 10
    });
</script>


