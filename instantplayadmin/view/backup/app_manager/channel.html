<style>
    .table-scrollable > .table > tbody > tr > td{white-space:normal;word-wrap: break-word; break-word: break-all;}
    .col-md-2.name {
        text-align: right;
        padding-right: 10px;
    }
    *{padding:0;margin:0}.cb{font-size:14px;text-align:center;color:#000}#pageGro{width:450px;height:25px;margin:0 auto;padding-top:30px}#pageGro div,#pageGro div ul li{font-size:12px;color:#999;line-height:23px;display:inline-block;margin-left:5px}#pageGro div ul li{width:22px;text-align:center;border:1px solid #999;cursor:pointer}#pageGro div ul li.on{color:#fff;background:#3c90d9;border:1px solid #3c90d9}#pageGro .pageUp,#pageGro .pageDown,#pageGro .pagestart,#pageGro .pageend{width:63px;border:1px solid #999;cursor:pointer}
</style>

<!-- BEGIN CONTAINER -->
<div class="page-container">

    {include layout/left.html}

    <div class="page-content-wrapper">
        <div class="page-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light">
                        <div class="portlet-title">
                            <!-- <div class="actions">
                                <div class="btn-group">
                                    <a class="btn btn-default btn-circle" href="javascript:;" data-toggle="dropdown">
                                        <i class="fa fa-share"></i> 导出 <i class="fa fa-angle-down"></i>
                                    </a>

                                    <ul class="dropdown-menu pull-right">
                                        <li>
                                            <a href="javascript:void(0);" onclick="export_data();">
                                                Excel </a>
                                        </li>
                                        <li class="divider">
                                        </li>
                                        <li>
                                            <a href="javascript:;">
                                                PDF </a>
                                        </li>
                                        <li>
                                            <a href="javascript:;">
                                                WORD </a>
                                        </li>

                                    </ul>
                                </div>
                            </div> -->
                        </div>
                        <div class="portlet-body">
                            <div class="table-container">
                                <div class="table-actions-wrapper">
									<span>
									</span>
                                    <select class="table-group-action-input form-control input-inline input-small input-sm">
                                        <option value="select">选择</option>
                                        <!--<option value="delete">批量删除</option>-->
                                    </select>
                                    <button id="add_channel_btn" class="btn btn-sm default blue"><i class="fa fa-plus"></i> 添加</button>
                                    <button type="button" class="btn btn-sm default red delete_game"><i class="fa fa-times"></i> 删除</button>
                                </div>
                                <table class="table table-striped table-bordered table-hover" id="datatable_products">
                                    <thead>
                                    <tr role="row" class="heading">
                                        <th width="2%">
                                            <input type="checkbox" class="group-checkable">
                                        </th>
                                        <th width="2%">
                                            id
                                        </th>
                                        <th width="5%">
                                            F值
                                        </th>
                                        <th width="5%">
                                            渠道名称
                                        </th>

                                        <th width="5%">
                                            系统
                                        </th>

                                        <th width="5%">
                                            操作时间
                                        </th>

                                        <th width="5%">
                                            操作
                                        </th>
                                    </tr>
                                    <tr role="row" class="filter">
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="f_key" >
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="name" >
                                        </td>
                                        <td>
                                            <select name="os" class="form-control form-filter input-sm">
                                                <option value="">请选择</option>
                                            {foreach ($osDesc as  $k=>$v)  }
                                                <option value="{$k}">{$v}</option>
                                            {/foreach}
                                            </select>
                                        </td>

                                        <td>

                                            <div class="input-group date form_datetime margin-bottom-5">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px" readonly name="from" id="from" placeholder="From">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button" style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button" style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>


                                            <div class="input-group date form_datetime margin-bottom-5">
                                                <input type="text" class="form-control form-filter input-sm" style="height: 34px"  readonly name="to" id="to" placeholder="to">
                                                <span class="input-group-btn">
                                                    <!--<button class="btn default date-reset" type="button"  style="margin-right: 0"><i class="fa fa-times"></i></button>-->
                                                    <button class="btn default date-set" type="button"  style="margin-right: 0"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>

                                        </td>

                                        <td>
                                            <div class="margin-bottom-5">
                                                <button class="btn btn-sm yellow filter-submit margin-bottom"><i class="fa fa-search"></i> 搜索</button>
                                            </div>
                                            <button class="btn btn-sm green filter-cancel"><i class="fa fa-times"></i> 重置</button>
                                        </td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- End: life time stats -->
                </div>
            </div>
            <!-- END PAGE CONTENT-->
        </div>
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->

<div class="modal fade" id="add_channel_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style=" padding-top: 40px">
      <div class="modal-content" style=" margin: 0!important">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel" style="text-align: center;">添加渠道</h4>
        </div>
        <div class="modal-body">
            
            <div class="row static-info" style="margin-top: 20px; margin-bottom: 20px;">
                <div class="col-md-2 name">
                    渠道名称
                </div>
                <div class="col-md-4 value">
                    <input id="channel_name" type="text" style="width: 75%">
                </div>
                <div class="col-md-2 name">
                    F值
                </div>
                <div class="col-md-4 value">
                    <input id="f_key" type="text" style="width: 75%">
                </div>
            </div>
            <div class="row static-info" style="margin-top: 20px; margin-bottom: 20px;">
                <div class="col-md-2 name">
                    系统
                </div>
                <div class="col-md-4 value">
                    <select id="os_select" style="width: 75%; height: 24px">
                        <option value="1">安卓</option>
                        <option value="2">苹果</option>
                    </select>
                </div>
                <div class="col-md-2 name">
                    配置游戏
                </div>
                <div class="col-md-4 value">
                    <select id="type_select" style="width: 75%; height: 24px">
                        <option value="1">所有游戏</option>
                        <option value="2">自定义</option>
                    </select>
                </div>
            </div>
            <hr>
            <div class="row static-info" style="margin-top: 30px; margin-bottom: 30px;" id="show_div">
                <div class="col-md-3 name" style="padding: 0; width: 120px; margin-left: 55px; margin-bottom:15px">
                    <input id="game_id_input" type="text" placeholder="游戏ID" style="width: 100px;">
                </div>
                <div class="col-md-3 value" style="padding: 0">
                    <button  id="game_search" class="btn btn-sm default blue" style="width: 50px;height: 26px">搜索</button>
                    <button  id="game_selected" class="btn btn-sm default blue" style="height: 26px">已选中</button>
                </div>
                <div class="table-container" style="padding-left: 55px; padding-right: 55px" id="table_div">
                    <table class="table table-striped table-bordered table-hover" id="games_table">
                        <thead>
                        <tr role="row" class="heading">
                            <th width="1%">
                                <input type="checkbox" checked="true" id="all_check" class="group-checkable">
                            </th>
                            <th width="8%">
                                游戏ID
                            </th>
                            <th width="10%">
                                游戏名称
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                            {foreach ($games as $game)}
                            <tr role="row" class="even">
                                <td>
                                    <input class="sub_check" type="checkbox" value="{$game['id']}">
                                </td>
                                <td>{$game['id']}</td>
                                <td>{$game['name']}</td>
                            </tr>
                            {/foreach}

                        </tbody>
                    </table>
                </div>
                <input type="hidden" id="start_page" value="0">
                <input type="hidden" id="current_page" value="0">
                <input type="hidden" id="show_per_page" value="10">
                <input type="hidden" id="end_page" value="10">
                
                <div id="pageGro" class="cb" style="padding: 0">
                    <div class="pagestart">首页</div>
                    <div class="pageUp">上一页</div>
                    <div class="pageList">
                    <ul></ul>
                    </div>
                    <div class="pageDown">下一页</div>
                    <div class="pageend">尾页</div>
                </div>
            </div>
            <div class="row static-info" style="margin-top: 20px; margin-bottom: 20px; text-align: center;">
                    <button  id="add_cancel" class="btn btn-sm default yellow" style="width: 60px; margin-right: 30px;">取消</button>
                    <button  id="add_submit" class="btn btn-sm default green" style="width: 60px;">确定</button>
            </div>

        </div>
      </div>
    </div>
</div>

<script>

    function export_data(){
        var message = $("#message").val();
        var from = $("#from").val();
        var to = $("#to").val();
        var mobile = $("#mobile").val();

        location.href="/?ac=export&message="+message+"&from="+from+"&to="+to+"&mobile="+mobile ;
    }

    function all_del(){
        var message = $("#message").val();
        var from = $("#from").val();
        var to = $("#to").val();
        var mobile = $("#mobile").val();

        if(!message && !from && !to && !mobile){
            return alert("搜索条件为空不允许删除");
        }

        bootbox.confirm("搜索后的结果，全删除无法恢复，确定?", function(result) {
            if(result == true){
                $.ajax({
                    type: 'GET',
                    url: "/?ac=searchAllDel&to="+to +"&from="+from+"&message="+message+"&mobile="+mobile,
                    dataType: 'json',
                    success: function(data){
                        alert(data.msg);
//                        location.reload();
                    }

                });
            }
        });



    }

</script>



<script>

    var EcommerceProducts = function () {

        var initPickers = function () {
            //init date pickers
            $('.date-picker').datepicker({
                rtl: Metronic.isRTL(),
                autoclose: true
            });
        }

        var handleProducts = function() {
            var grid = new Datatable();

            grid.init({
                src: $("#datatable_products"),
                onSuccess: function (grid) {
                    // execute some code after table records loaded
                },
                onError: function (grid) {
                    // execute some code on network or other general error
                },
                loadingMessage: 'Loading...',
                dataTable: { // here you can define a typical datatable settings from http://datatables.net/usage/options

                    // Uncomment below line("dom" parameter) to fix the dropdown overflow issue in the datatable cells. The default datatable layout
                    // setup uses scrollable div(table-scrollable) with overflow:auto to enable vertical scroll(see: assets/global/scripts/datatable.js).
                    // So when dropdowns used the scrollable div should be removed.
                    //"dom": "<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'<'table-group-actions pull-right'>>r>t<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'>>",

                    "lengthMenu": [
                        [10, 20, 50, 100, 150 , 999999],
                        [10, 20, 50, 100, 150 , '所有(会很慢)'] // change per page values here
                    ],
                    "pageLength": 20, // default record count per page
                    "ajax": {
                        "url": "/app_manager/no/channel/getlist/" // ajax source
                    },
                    "aoColumnDefs" : [{  // define columns sorting options(by default all columns are sortable extept the first checkbox column)
                        'bSortable' : false,
                        'aTargets' : [ 0,2,3,4,6]
                    }],
                    "order": [
                        [1, "desc"]
                    ] // set first column as a default sort by asc
                }
            });

            // handle group actionsubmit button click
            grid.getTableWrapper().on('click', '.delete_game', function (e) {
                e.preventDefault();
                var action = $(".table-group-action-input", grid.getTableWrapper());
                if (grid.getSelectedRowsCount() > 1) {
                    alert('请选择单条记录');
                    return;
                }
                if (action.val() != "" && grid.getSelectedRowsCount() > 0) {
                    id = $('tbody > tr > td:nth-child(1) input[type="checkbox"]:checked').val();
                    if(confirm('确认要删除该配置吗')!=true){
                        return;
                    }
                    $.ajax({
                        type: 'GET',
                        url: "/app_manager/no/channel/delete/id="+id,
                        dataType: 'json',
                        success: function(data){
                            if (data.code == 200) {
                                alert("删除成功");
                                location.reload();
                            } else {
                                alert(data.message);
                            }
                        }

                    });


                } else if (action.val() == "") {
                    Metronic.alert({
                        type: 'danger',
                        icon: 'warning',
                        message: '请选择一个动作',
                        container: grid.getTableWrapper(),
                        place: 'prepend'
                    });
                } else if (grid.getSelectedRowsCount() === 0) {
                    Metronic.alert({
                        type: 'danger',
                        icon: 'warning',
                        message: '至少选择一条数据',
                        container: grid.getTableWrapper(),
                        place: 'prepend'
                    });
                }
            });
        }

        return {

            //main function to initiate the module
            init: function () {

                handleProducts();
                initPickers();

            }

        };

    }();

    var showType = 0;
    var update = false;
    var updateId = 0;

    jQuery(document).ready(function() {
        EcommerceProducts.init();
        $("#add_channel_btn").click(function(){
            $("#myModalLabel").html("添加渠道");
            update = false;
            updateId = 0;
            resetModal();
            var type = $("#type_select").find("option:selected").val();
            if (type == 1) {
                showType = type;
                $("#show_div").hide();
            } else if (type == 2) {
                showType = type;
                $("#show_div").show();
            }
            $('#add_channel_modal').modal();
        });
        $('#add_cancel').click(function(){
            $('.close').click();
        });
        $("#type_select").change(function(){
            var type = $(this).find("option:selected").val();
            if (type == 1) {
                showType = type;
                $("#show_div").hide();
            } else if (type == 2) {
                showType = type;
                $("#show_div").show();
            }
        }); 

        $("#all_check").change(function(){
            if ($(this).prop("checked")) {
                $(".sub_check").each(function(){
                    $(this).get(0).checked = true;
                    $(this).parent("span").addClass("checked");
                });
            } else {
                $(".sub_check").each(function(){
                    $(this).get(0).checked = false;
                    $(this).parent("span").removeClass("checked");
                });
            }
        });

        $('#add_submit').click(function(){
            var channel_name = $('#channel_name').val();
            if (!channel_name || channel_name=='') {
                alert('请输入渠道名称');
                return;
            }
            var f_key = $('#f_key').val();
            if (!f_key || f_key=='') {
                alert('请输入F值');
                return;
            }
            var os = $('#os_select').find("option:selected").val();
            if (!os || os=='') {
                alert('请选择系统');
                return;
            }
            var ids;
            if (showType == 1) {
                ids = 'all';
            } else if (showType == 2) {
                ids = [];
                $(".sub_check").each(function(){
                    if ($(this).prop("checked")) {
                        var id = $(this).val();

                        if (!ids.includes(id)) {
                            ids.push(id);
                        }
                    }
                });
            }

            console.log(ids);

            if (!ids || ids.length == 0) {
                alert('请勾选游戏');
                return;
            }
            
            var url = "/app_manager/no/channel/add/";
            var msg = "添加成功";
            if (update) {
                url = "/app_manager/no/channel/update/";
                msg = "修改成功";
            }
            $.ajax({
                type: "POST",
                url: url,
                data: {
                    channel_name:channel_name,
                    f_key:f_key,
                    os:os,
                    gameIds:ids,
                    id:updateId,
                },
                dataType:'json',
                success: function(data){
                    if (data.code == 200) {
                        alert(msg);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                    
                }
            });



        });
        
        $('#game_search').click(function(){
            var game_id = $("#game_id_input").val();
            if (!game_id || game_id=='') {
                // 显示所有
                initTable();
            } else {
                $('#games_table tbody').children("tr").each(function(){
                    if ($(this).find(".sub_check").val() != game_id) {
                        $(this).css('display', 'none');
                    }
                })
            }
        });

        $('#game_selected').click(function(){
            $('#games_table tbody').children("tr").each(function(){
                if ($(this).find(".sub_check").prop("checked") == false) {
                    $(this).css('display', 'none');
                }
            })
        });

    });

    function updateChannel(elem) {
        $("#myModalLabel").html("修改");
        resetModal();
        var id = $(elem).val();
        $.ajax({
            type: "POST",
            url: "/app_manager/no/channel/getOne/",
            data: {
                id:id,
            },
            dataType:'json',
            success: function(data){
                if (data.code == 200) {
                    updateId = id;
                    update = true;
                    var channel = data.data;
                    $("#channel_name").val(channel.name);
                    $("#f_key").val(channel.f_key);
                    if (channel.games == 'all') {
                        showType = 1;
                        $("#type_select").val(showType);
                        $("#show_div").hide();
                    } else {
                        showType = 2;
                        $("#type_select").val(showType);
                        $("#show_div").show();
                        // 清空
                        $("#all_check").get(0).checked = false;
                        $("#all_check").parent("span").removeClass("checked");
                        $(".sub_check").each(function(){
                            $(this).get(0).checked = false;
                            $(this).parent("span").removeClass("checked");
                        });
                        // 勾选
                        $(".sub_check").each(function(){
                            for (var i = 0; i < channel.games.length; i++) {
                                if ($(this).val() == channel.games[i]) {
                                    $(this).get(0).checked = true;
                                    $(this).parent("span").addClass("checked");
                                    break;
                                }
                            }
                        });
                    }
                    
                    $('#add_channel_modal').modal();
                } else {
                    alert(data.message);
                }
            }
        });
    }

    function resetModal() {
        $("#channel_name").val('');
        $("#f_key").val('');
        $("#all_check").get(0).checked = false;
        $("#all_check").parent("span").removeClass("checked");
        $(".sub_check").each(function(){
            $(this).get(0).checked = false;
            $(this).parent("span").removeClass("checked");
        });
        $("#os_select").val(1);
        $("#type_select").val(1);

    }


</script>

<script>

    $("#datatable_products").on("click",".delone",function(){
        var id = $(this).attr("data-id");
        bootbox.confirm("Are you sure?", function(result) {
            if(result == true){
                $.ajax({
                    type: 'GET',
                    url: "/user/delOne/uid="+id ,
                    dataType: 'json',
                    success: function(data){
                        location.reload();
                    }

                });
            }
        });



    });

    if (!jQuery().datetimepicker) {
        alert("error:333");
    }

    $(".form_datetime").datetimepicker({
        isRTL: Metronic.isRTL(),
        minView: "month",
        format: "yyyy-mm-dd",
        autoclose: true,
        todayBtn: true,
        startDate: "2013-02-14",
        pickerPosition: (Metronic.isRTL() ? "bottom-right" : "bottom-left"),
        minuteStep: 10
    });

    var show_per_page = 10;
    var number_of_items = {$gamesCount};
    var pageCount = Math.ceil(number_of_items / show_per_page);

    function initTable() {
        $('#games_table tbody').children("tr").css('display', 'none');
        $('#games_table tbody').children("tr").slice(0, show_per_page).css('display', 'table-row');
        $('#start_page').val(0);
        $('#current_page').val(0);
        $('#show_per_page').val(show_per_page);
        $('#end_page').val(pageCount);
        if(pageCount > 5) {
            page_icon(1, 5, 0);
        } else {
            page_icon(1, pageCount, 0);
        }
    }

    $(function() {
        initTable();
        $("#pageGro").on("click","li",function() {
            console.log(1);
            var pageNum = parseInt($(this).html()) - 1;
            var page = pageNum + 1;
            var show_per_page = parseInt($('#show_per_page').val());
            start_from = pageNum * show_per_page;
            end_on = start_from + show_per_page;
            $('#games_table tbody').children("tr").css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
            if(pageCount > 5) {
                pageGroup(page, pageCount);
            } else {
                $(this).addClass("on");
                $(this).siblings("li").removeClass("on");
            }
        });
        $("#pageGro .pageUp").click(function() {
            var pageNum = parseInt($("#pageGro li.on").html());
            if(pageNum <= 1) {
                var page = pageNum;
            } else {
                var page = pageNum - 1;
            }
            var show_per_page = parseInt($('#show_per_page').val());
            start_from = page * show_per_page - show_per_page;
            end_on = start_from + show_per_page;
            $('#games_table tbody').children("tr").css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
            if(pageCount > 5) {
                pageUp(pageNum, pageCount);
            } else {
                var index = $("#pageGro ul li.on").index();
                if(index > 0) {
                    $("#pageGro li").removeClass("on");
                    $("#pageGro ul li").eq(index - 1).addClass("on");
                }
            }
        });
        $("#pageGro .pageDown").click(function() {
            var pageNum = parseInt($("#pageGro li.on").html());
            var page = pageNum;
            if(pageNum === pageCount) {
                page = pageNum - 1;
            }
            var show_per_page = parseInt($('#show_per_page').val());
            start_from = page * show_per_page;
            end_on = start_from + show_per_page;
            $('#games_table tbody').children("tr").css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
            if(pageCount > 5) {
                pageDown(pageNum, pageCount);
            } else {
                var index = $("#pageGro ul li.on").index();
                if(index + 1 < pageCount) {
                    $("#pageGro li").removeClass("on");
                    $("#pageGro ul li").eq(index + 1).addClass("on");
                }
            }
        });
        $("#pageGro .pagestart").on("click", function() {
            var pageNum = $('#start_page').val();
            start_from = pageNum * show_per_page;
            end_on = start_from + show_per_page;
            $('#games_table tbody').children("tr").css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
            if(pageCount > 5) {
                pageGroup(1, pageCount);
            } else {
                var index = $("#pageGro ul li.on").index();
                if(index < pageCount) {
                    $("#pageGro li").removeClass("on");
                    $("#pageGro ul li:first").addClass("on");
                }
            }
        });
        $("#pageGro .pageend").on("click", function() {
            var pageNum1 = $('#end_page').val();
            var pagenum = pageNum1 - 2
            var page = pageNum1 - 1;
            start_from = page * show_per_page;
            end_on = start_from + show_per_page;
            $('#games_table tbody').children("tr").css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
            if(pageCount > 5) {
                pageGroup(pagenum, pageNum1);
                $("#pageGro ul li:last-child").addClass("on").siblings().removeClass("on");
            } else {
                var index = $("#pageGro ul li.on").index();
                if(index < pageCount) {
                    $("#pageGro li").removeClass("on");
                    $("#pageGro ul li:last-child").addClass("on");
                }
            }
        });
    });

    function pageGroup(pageNum, pageCount) {
        switch(pageNum) {
            case 1:
                page_icon(1, 5, 0);
                break;
            case 2:
                page_icon(1, 5, 1);
                break;
            case pageCount - 1:
                page_icon(pageCount - 4, pageCount, 3);
                break;
            case pageCount:
                page_icon(pageCount - 4, pageCount, 4);
                break;
            default:
                page_icon(pageNum - 2, pageNum + 2, 2);
                break;
        }
    }

    function page_icon(page, count, eq) {
        var ul_html = "";
        for(var i = page; i <= count; i++) {
            ul_html += "<li>" + i + "</li>";
        }
        $("#pageGro ul").html(ul_html);
        $("#pageGro ul li").eq(eq).addClass("on");
    }

    function pageUp(pageNum, pageCount) {
        switch(pageNum) {
            case 1:
                break;
            case 2:
                page_icon(1, 5, 0);
                break;
            case pageCount - 1:
                page_icon(pageCount - 4, pageCount, 2);
                break;
            case pageCount:
                page_icon(pageCount - 4, pageCount, 3);
                break;
            default:
                page_icon(pageNum - 2, pageNum + 2, 1);
                break;
        }
    }

    function pageDown(pageNum, pageCount) {
        switch(pageNum) {
            case 1:
                page_icon(1, 5, 1);
                break;
            case 2:
                page_icon(1, 5, 2);
                break;
            case pageCount - 1:
                page_icon(pageCount - 4, pageCount, 4);
                break;
            case pageCount:
                break;
            default:
                page_icon(pageNum - 2, pageNum + 2, 3);
                break;
        }
    }

</script>
